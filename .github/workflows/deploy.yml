name: Deploy

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.event == 'push' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check Netlify secrets
        id: netlify
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
          VITE_API_URL: ${{ secrets.VITE_API_URL }}
        run: |
          if [ -n "$NETLIFY_AUTH_TOKEN" ] && [ -n "$NETLIFY_SITE_ID" ] && [ -n "$VITE_API_URL" ]; then
            echo "ready=true" >> "$GITHUB_OUTPUT"
          else
            echo "ready=false" >> "$GITHUB_OUTPUT"
            echo "Netlify deploy skipped: set NETLIFY_AUTH_TOKEN, NETLIFY_SITE_ID, VITE_API_URL."
          fi

      - name: Build frontend
        if: steps.netlify.outputs.ready == 'true'
        run: npm -w frontend run build
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL }}

      - name: Deploy frontend to Netlify
        if: steps.netlify.outputs.ready == 'true'
        uses: netlify/actions/cli@v3
        with:
          args: deploy --dir=frontend/dist --prod
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}

      - name: Trigger backend deploy (Render)
        env:
          RENDER_DEPLOY_HOOK_URL: ${{ secrets.RENDER_DEPLOY_HOOK_URL }}
        run: |
          if [ -n "$RENDER_DEPLOY_HOOK_URL" ]; then
            curl -fsSL -X POST "$RENDER_DEPLOY_HOOK_URL"
          else
            echo "Render deploy skipped: set RENDER_DEPLOY_HOOK_URL."
          fi
